# ModelData3Tool
本工具是基于 Babylon.js 7.x 的 Web 端 3D 场景编辑器，支持 WebGPU/WebGL 双引擎，提供模型导入、材质编辑、灯光布置、后期处理及参数驱动器动画等全流程创作能力，采用 Vue 3 + Express 技术栈，适用于数字孪生与可视化大屏场景。

## ✨ 特性

### 🎨 3D 编辑
- **双渲染引擎**: 支持 WebGPU 和 WebGL，自动检测并回退
- **模型导入**: 支持 .babylon,  .glb格式，以及 **高斯泼溅 (.ply)** 格式
- **高斯泼溅优化**: 具备后期处理隔离、高精度渲染和亮度自动校准功能
- **材质编辑**: PBR材质系统，实时预览
- **灯光系统**: 方向光、点光、聚光等多种光源
- **变换工具**: 移动、旋转、缩放 Gizmo

### ⚙️ 高级功能
- **后期处理**: Bloom, SSAO, FXAA, 色调映射
- **参数驱动器**: 通过 JavaScript 代码实现程序化动画
- **场景管理**: 完整的场景保存、加载、导出
- **实时协作**: WebSocket 实时同步 (即将推出)

### 🛠️ 工具集
- **材质编辑器**: 完整的材质参数调整
- **粒子编辑器**: 粒子系统编辑 (即将推出)
- **脚本控制台**: 运行自定义脚本

### 💾 数据管理
- **本地存储**: 自动保存到浏览器本地存储
- **云端存储**: 完整的后端 API 和数据库支持
- **版本控制**: 场景版本历史和回滚
- **资源管理**: 贴图、模型统一管理

## 🚀 快速开始

### 环境要求

- Node.js 18.0.0 或更高版本
- npm 9.0.0 或更高版本
- 现代浏览器 (Chrome, Firefox, Edge, Safari)

### 安装与启动

本项目包含前端和后端两个部分，建议分别启动。
本项目已完成 Docker 化配置，支持通过 Docker Compose 一键启动前后端服务。

## 目录结构说明

```text
ModelData3d/
├── backend/
│   ├── Dockerfile          # 后端镜像构建文件
│   └── .dockerignore       # 构建忽略文件
├── frontend/
│   ├── Dockerfile          # 前端镜像构建文件
│   ├── .dockerignore       # 构建忽略文件
│   └── nginx.conf          # 前端 Nginx 配置文件
├── backend-image.tar       # 预构建的后端镜像包
├── frontend-image.tar      # 预构建的前端镜像包
└── docker-compose.yml      # 多容器编排文件
```

## 准备工作

1. 确保机器上已安装 [Docker](https://www.docker.com/) 和 [Docker Compose](https://docs.docker.com/compose/)。
2. 将此 `ModelData3d` 文件夹拷贝到项目的根目录下（即与 `frontend` 和 `backend` 文件夹同级）。

## 部署说明

此文件夹专为“离线分发”设计。由于分发包中不包含源代码，因此**必须**先加载镜像包。

## 启动步骤

在 `ModelData3d` 目录下打开终端，执行以下命令：

1. **加载镜像包**（仅第一次或镜像更新时需要）：
   ```bash
   docker load -i backend-image.tar
   docker load -i frontend-image.tar
   ```

2. **启动服务**：
   ```bash
   docker-compose up -d
   ```

启动成功后：
- **前端地址**: [http://localhost:3695](http://localhost:3695)
- **后端 API**: [http://localhost:3358/api/v1](http://localhost:3358/api/v1)

## 数据持久化

项目的数据（SQLite 数据库和上传的资产文件）将持久化在 `ModelData3d/storage` 目录下。即使删除容器，数据也不会丢失。

## 停止服务

```bash
docker-compose down
```

### 用户指南

#### 1. 场景创建

1. 打开应用后，选择渲染引擎 (WebGPU 或 WebGL)
2. 配置场景参数 (HDR, 后期处理, 材质系统)
3. 点击"创建场景"进入编辑器

#### 2. 模型导入

1. 点击右侧"导入"面板
2. 选择要导入的文件类型
3. 拖拽文件或点击上传
4. 模型自动加载到场景中

#### 3. 对象编辑

1. 在场景树或 3D 视图中选择对象
2. 在右侧面板调整变换参数
3. 或使用 Gizmo 工具直接操作

#### 4. 材质编辑

1. 选择对象后切换到材质面板
2. 调整颜色、金属度、粗糙度等参数
4. 添加贴图增强效果

#### 5. 灯光设置

1. 点击"添加灯光"按钮
2. 选择灯光类型
3. 调整位置、颜色、强度
4. 配置阴影参数

#### 6. 程序化动画

1. 右键点击任意参数
2. 选择"添加驱动器"
3. 在代码编辑器中编写 JavaScript
4. 测试并保存

### 当前实现概览

- 启动流程: 进入应用后首先弹出启动窗口, 必须选择渲染引擎 (WebGPU/WebGL) 和抗锯齿配置或打开已有场景, 才能进入主编辑界面
- 顶部菜单: 文件/编辑/视图/工具/帮助 菜单均已绑定实际逻辑, 支持新建场景、导入模型、保存/导出场景 (Babylon JSON / GLB)、撤销/重做、视图切换、网格/坐标轴显隐、打开材质/驱动器编辑器和脚本控制台等
- 场景管理: 前端使用 Pinia `useSceneStore` 管理 Babylon 引擎和场景生命周期, 统一维护对象/材质/灯光/摄像机列表、选中状态、复制/粘贴/删除、驱动器执行以及 FPS/Draw Calls/顶点数等运行时统计
- 模型导入: 前端基于 `@babylonjs/loaders` 支持本地 .babylon / .gltf / .glb / .obj / .stl / .fbx 模型文件, 通过 `URL.createObjectURL` 与 Babylon `SceneLoader` 直接加载, 同时支持将文件拖拽到 3D 视图中导入
- 场景保存导出: 支持将当前场景序列化为 .babylon JSON 文件, 以及使用 `@babylonjs/serializers` 导出为 GLB, 导出时自动过滤网格/坐标轴等辅助对象
- 环境与后期: 支持通过 `HDRCubeTexture` 加载 HDR 环境贴图并生成天空盒, 提供 Bloom/SSAO/FXAA/色调映射等后期处理开关和参数 (通过状态存储)
- 材质与灯光: 已实现 PBR/Standard 材质映射到前端材质面板, 并将 Babylon 灯光实例同步为可编辑的灯光数据结构
- 驱动器系统: 支持在前端以 `Map<string, Driver>` 形式管理参数驱动器, 驱动器代码在渲染循环中按帧执行, 可控制位置/旋转/缩放等属性
- 脚本控制台: 提供独立的脚本控制台面板, 以沙箱方式执行用户脚本, 暴露 `scene` / `engine` / `BABYLON` 等安全接口, 并在面板中展示日志输出

## 🏗️ 架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端 (Frontend)                      │
├─────────────────────────────────────────────────────────┤
│  Vue 3 + TypeScript + Babylon.js + Tailwind CSS        │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌────────────────┐   │
│  │   组件系统   │  │   状态管理   │  │   Babylon.js   │   │
│  │             │  │   (Pinia)   │  │   封装层       │   │
│  └─────────────┘  └─────────────┘  └────────────────┘   │
├─────────────────────────────────────────────────────────┤
│                    后端 (Backend)                       │
├─────────────────────────────────────────────────────────┤
│  Node.js + Express + TypeScript + SQLite               │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌────────────────┐   │
│  │   REST API  │  │  WebSocket  │  │   文件服务     │   │
│  │             │  │   实时通信   │  │                │   │
│  └─────────────┘  └─────────────┘  └────────────────┘   │
├─────────────────────────────────────────────────────────┤
│                   数据存储 (Storage)                    │
├─────────────────────────────────────────────────────────┤
│  SQLite 数据库 + 文件系统存储                           │
└─────────────────────────────────────────────────────────┘
```

### 技术栈

#### 前端
- **Vue 3** - 渐进式 JavaScript 框架
- **TypeScript** - 类型安全的 JavaScript
- **Babylon.js 7.x** - 3D 渲染引擎
- **Tailwind CSS** - 原子化 CSS 框架
- **Pinia** - 状态管理
- **Vite** - 构建工具

#### 后端
- **Node.js 18+** - JavaScript 运行时
- **Express 4.x** - Web 框架
- **TypeScript** - 类型安全的 JavaScript
- **SQLite** - 轻量级数据库
- **Socket.io** - WebSocket 库

## 📊 项目状态

### 当前版本: v1.0.7 (Stable)

### 开发进度

#### ✅ 已完成
- [x] 基础场景编辑
- [x] 模型导入/导出 (支持 GLTF, GS (.ply) 等)
- [x] 场景截图导出 (支持透明背景、高清精度)
- [x] 摄像机参数实时同步与多视图布局 (单视图/四视图)
- [x] 高斯泼溅 (Gaussian Splatting) 渲染隔离与优化
- [x] HDR 环境一键替换与管线同步
- [x] 图层面板自动同步优化
- [x] 材质编辑 (PBR/Standard)
- [x] 灯光系统
- [x] 变换工具 (Gizmo)
- [x] 参数驱动器
- [x] 后期处理效果
- [x] 后端 API
- [x] 数据持久化

#### 🚧 进行中
- [ ] 粒子编辑器
- [ ] 实时协作
- [ ] 插件系统

#### 📋 计划中
- [ ] 地形编辑器
- [ ] 路径动画
- [ ] 物理引擎集成
- [ ] VR/AR 支持

## 🐛 已知问题

- WebGPU 在某些浏览器上可能不稳定
- 大场景 (>10000 对象) 性能有待优化
- HDR 环境贴图导入功能暂时隐藏

## 📝 更新日志--
此次版本是 v1.0.7 (2026-02-14)；早期的就不放了

### v1.0.7 (2026-02-14)
- **[新增]** 开启项目进入界面后，有一个提醒添加摄像机的消息，添加完相机后消失。
- **[新增]** 场景相机的参数增加了惯性 (阻尼感)、旋转灵敏度X 、旋转灵敏度 Y、缩放精度。
- **[新增]** 应许愿池的小朋友的想法，快速创建里面添加了新增文字标签的能力。
- **[新增]** 场景截图导出功能，支持在无 HDR 环境时自动应用透明背景。
- **[新增]** 摄像机参数实时同步逻辑，支持惯性、渲染模式等属性的双向绑定。
- **[新增]** 导出渲染时，可以选择倍数和设置分辨率。
- **[优化]** GLB导出器改为动态导出，显著减小初始包体积。
- **[优化]** 完善 `updateCameraProperty` 逻辑，确保不同相机类型（如弧向旋转相机）的特定参数正确同步。

### v1.0.6 (2026-02-09)
- **[修复]** 解决图层面板递归更新导致的 `RangeError: Maximum call stack size exceeded`。
- **[修复]** 解决隐藏/显示操作时的 `TypeError: Cannot read properties of null (reading 'setEnabled')`。
- **[优化]** 重构材质填充系统，支持多层（渐变、图片）复合显示，且各层透明度互不干扰。
- **[优化]** 提升模型导入及 HDR 贴图更换的响应速度，通过防抖机制解决界面卡顿。
- **[变更]** 调整材质面板布局，将“填充”功能整合为“基础属性”的首选子项。
- **[修复]** 修正图片填充参数（缩放、偏移、旋转）无法实时同步到 3D 模型的问题。

### v1.0.5 (2026-02-08)
- **图层同步**: 优化图层面板同步机制，实现模型创建、粘贴、恢复、删除及场景加载后的实时自动同步。
- **交互反馈**: 取消模型选中时的 `HighlightLayer` 发光高亮效果，使视觉焦点更集中于 Gizmo 工具。
- **导入同步**: 统一 GLB/PLY 导入流程，确保导入后图层列表立即更新。

### v1.0.4 (2026-02-07)
- **GS 优化**: 实现高斯泼溅后期处理隔离，解决发光过强问题。
- **HDR 增强**: 支持 HDR 贴图一键替换，修复加载时的 `addOnce` 报错。
- **场景初始化**: 修复刷新后非纯黑问题，默认禁用网格和默认灯光。
- **精度提升**: 启用 32 位索引支持，优化 GS 模型远距离渲染精度。

### v1.0.2-beta (2026-01-31)
- 修复模型导入功能 (引入 `@babylonjs/loaders`)
- 优化导入面板 UI (隐藏冗余功能)
- 完善 Store 与 Engine 的同步机制

### v1.0.0-beta (2024-01-XX)
- 初始 Beta 版本发布
- 完整的 3D 场景编辑功能
- 后端 API 和数据库支持
- 完整的文档

## 📄 许可证

本项目采用 **双重许可** 模式：

1. **Community Edition**: 遵循 AGPL-3.0 协议 + 非商用附加条款。仅供个人学习和非营利性研究使用。必须保留所有版权标识和水印。
2. **Commercial Edition**: 针对企业和商业运营提供专项授权。请联系作者获取商业授权书。

## 👥 团队

- **项目负责人**: [Your Name]
- **UI/UX 设计**: [Designer Name]
- **核心开发**: [Developer Names]

## 🙏 致谢

感谢以下项目和社区的支持：

- [Babylon.js](https://www.babylonjs.com/) - 强大的 3D 引擎
- [Vue.js](https://vuejs.org/) - 渐进式前端框架
- [Blender](https://www.blender.org/) - 开源 3D 创作套件
